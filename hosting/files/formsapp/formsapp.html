<!DOCTYPE html>
<!-- This is a large file, can't easily break it into sub components as-->
<!-- a consequence of wanting no 'compile' stage for this application -->

<html>

<head>
    <meta charset="utf-8">
    <title> Atlas Forms</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Include the latest Realm Web SDK from CDN-->
    <script src="https://unpkg.com/realm-web/dist/bundle.iife.js"></script>
    <!-- Using vue.js in as lightweight way as possible-->
    <script src="https://unpkg.com/vue@3"></script>
    <!--  Style sheet  -->
    <link rel="stylesheet" href="../styles/style.css">
    <!--Layout and UI for this-->
    <link rel="stylesheet" href="formsapp_layout.css">
    <link rel="stylesheet" href="dynamicform.css">
    <!-- Installation specific parameters-->
    <script src="/appConfig.js"></script>
    <script src="./string_formating.js"></script>
    <script src="./utility_functions.js"></script>
    <script src="./listview_functions.js"></script>
    <script src="./formsapp.js"></script>
</head>

<body onLoad="formsOnLoad()">
    <div id="formsapp">
        <div class="formsappouterlayout">
            <div class="header">

                <div class="left">
                    <!-- odd binding as we do work on change to lookup details-->
                    2 Document Type:
                    <select name="docType" @change="selectDocType" v-model="selectedDocType">
                        <option v-for="docType in docTypes" :value="docType">{{docType.title}}</option>
                    </select>
                    <button class="headerbutton" @click="runQuery()"> Search </button>
                    <button class="headerbutton" @click="clearForm()"> Clear </button>
                    <button class="headerbutton" @click="editRecord()"> Edit </button>
                    <button class="headerbutton" @click="newRecord()"> Create </button>
                </div>
                <div class="right">
                    <button class="headerbutton" @click="logOut()"> Logout </button>
                </div>
            </div>

            <div class="listview_control">
                <!-- This data *is* a table and so HTML Table is fine to use-->
                <table class="listview" id="listviewheaderrow">
                    <tr>
                        <th @click="sortListviewColumn(fieldname)" class="listview"
                            v-for="(fieldname,idx) in listViewFields">
                            <div :id="'lh_'+fieldname" :ref="watchColumnResizing" class="listviewheader"
                                :style="{width: (98/listViewFields.length) +'vw'}">{{formatFieldname(fieldname)}}</div>
                        </th>
                    </tr>
                    <tr class="listview" :class="{selected:(result == currentDoc)}" v-for="result in results">
                        <td @click="currentDoc = result" class="listview" v-for="fieldname in listViewFields">
                            <div class="listviewitem"> {{ getFieldValue(result,fieldname) }} </div>
                        </td>
                    </tr>
                </table>
            </div>


            <!-- The code below may look daunting but it's relatively simple-->
            <!-- Iterate over keys in the template and print the values from the document-->
            <!-- Special cases are basially repeats for nested docs and arrays-->
            <!-- there is no easy recursive definition option -->

            <div class="formview_control">
                <div class='form_container'>
                    <!-- For each K,V pair in document-->
                    <!-- In the line below we add class 'newline' if value is a document or array
                      sorry that the code is ugly, put it in a function if it bothers you -->
                    <div :class="'dynamicformitem' + (['document','array'].includes(getBsonType(value))?' newline':'') "
                        v-for="(valtype,name) in selectedDocTypeSchema " :set=" value = getFieldValue(currentDoc,name)">

                        <!-- Nested Object -  We are only supprting one level of nesting here -->
                        <template v-if="getBsonType(valtype) == 'document'">
                            <div class="dynamicformlabel">{{formatFieldname(name)}}:</div>
                            <div class='form_container nested'>
                                <div class="dynamicformitem" v-for="(valtype,innername) in valtype "
                                    :set="value = getFieldValue(currentDoc,`${name}.${innername}`)">
                                    <div class="dynamicformlabel">{{formatFieldname(innername)}}:</div>
                                    <!-- Is this a nested object? -->
                                    <template v-if="getBsonType(value) == 'document'">
                                        <div> {{getBsonType(value)}} </div>
                                    </template>
                                    <template v-else>
                                        <input  v-on:input="formValueChange" :id=`${name}.${innername}` v-if="getBsonType(value) == 'date'" class="dynamicformvalue"
                                            :disabled="editing == false" type="datetime-local"
                                            :value="toDateTime(value)">
                                        <div  v-on:input="formValueChange" v-else :id=`${name}.${innername}` :contenteditable="editing?true:null" class="dynamicformvalue">
                                            {{value}} </div>
                                        <br />
                                    </template> 
                                </div>
                            </div>
                        </template>

                        <!-- Array -->
                       
                        <template v-else-if="getBsonType(valtype) == 'array'">
                            <div class=" dynamicformlabel">{{formatFieldname(name)}}:
                            </div>
                            <div class="dynamicformitem arrayscroller">
                                    <!-- If the Array is Empty we still need to show at least one member-->
                                    <!-- to allow for searching or adding a first element -->
                                <div v-for="(arrayElement,arrayidx) in value?.length>0?value:[{a:1}]" class='form_container nested'>
                                    <!-- With an Array, for each array memeber we repeat the top level code-->
                                    <!-- Not adding code for nested arrays but will support arrays of objects-->

                                    <!-- Object in Array-->
                                    <template v-if="getBsonType(arrayElement) == 'document'">
                                        <div class="dynamicformitem"
                                            v-for="(valtype,innername) in getFieldDataType(name)[0]"
                                            :set="value = getFieldValue(arrayElement,innername)">
                                            <div class="dynamicformlabel">{{formatFieldname(innername)}}:</div>
                                            <input  v-on:input="formValueChange" :id=`${name}.${arrayidx}.${innername}`  v-if="getBsonType(value) == 'date'" class="dynamicformvalue"
                                                :disabled="editing == false" type="datetime-local"
                                                :value="toDateTime(value)">
                                            <div v-else  v-on:input="formValueChange" :id=`${name}.${arrayidx}.${innername}`  :contenteditable="editing?true:null" class="dynamicformvalue">
                                                {{value}}
                                            </div>
                                    </template>
                                    <!-- Scalar in an Array-->
                                    <template v-else>
                                        <input  v-on:input="formValueChange" :id=`${name}.${arrayidx}` v-if="getBsonType(arrayElement) == 'date'" class="dynamicformvalue"
                                            :disabled="editing == false" type="datetime-local"
                                            :value="toDateTime(arrayElement)">
                                        <div  v-on:input="formValueChange" :id=`${name}.${arrayidx}` v-else :contenteditable="editing?true:null" class="dynamicformvalue">
                                            {{arrayElement}} </div>
                                    </template>
                                </div>
                            </div>
                        </template>

                        <!-- Scalar value, formatting and control based on type -->
                        <template v-else>
                            <div class="dynamicformlabel">{{formatFieldname(name)}}:</div>
                            <input  v-on:input="formValueChange" v-if="getBsonType(value) == 'date'" class="dynamicformvalue"
                                :disabled="editing == false" type="datetime-local" :value="toDateTime(value)" :id="name">
                            <div v-on:input="formValueChange" :id="name" v-else :contenteditable="editing?true:null" class="dynamicformvalue">{{value}} </div>
                            <br />
                        </template>
                    </div>
                </div>
            </div>

        </div>
    </div>
</body>

</html>

</html>